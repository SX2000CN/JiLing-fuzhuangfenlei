# 开发者指南

本文档面向开发者，介绍项目的代码结构、核心模块和API使用方法。

## 项目架构

项目采用分层架构设计：

```
src/
├── core/      # 核心业务逻辑层
├── gui/       # 表现层（图形界面）
├── cli/       # 命令行接口层
└── utils/     # 工具函数层
```

## 核心模块

### 1. ModelFactory (src/core/model_factory.py)

模型工厂，负责创建和管理深度学习模型。

**支持的模型：**

| 模型名称 | timm名称 | 参数量 | 推荐用途 |
|---------|---------|-------|---------|
| tf_efficientnetv2_s | tf_efficientnetv2_s_in21ft1k | 22M | 默认推荐 |
| convnext_tiny | convnext_tiny_in22ft1k | 29M | 备选方案 |
| resnet50 | resnet50 | 26M | 轻量部署 |

**使用示例：**
```python
from src.core.model_factory import ModelFactory

# 创建模型
model = ModelFactory.create_model(
    model_name='tf_efficientnetv2_s',
    num_classes=3,
    pretrained=True
)
```

### 2. ClothingClassifier (src/core/pytorch_classifier.py)

图像分类器，负责模型推理。

**主要方法：**

```python
from src.core.pytorch_classifier import ClothingClassifier

# 初始化分类器
classifier = ClothingClassifier(
    model_path='models/best_model.pth',
    device='auto'  # 自动选择GPU/CPU
)

# 单张图片分类
class_name, confidence, result = classifier.predict_single('image.jpg')

# 批量分类
results = classifier.batch_predict(image_paths, batch_size=32)

# 文件夹分类（自动组织文件）
classifier.classify_folder(input_folder, output_folder)
```

**返回结果格式：**
```python
{
    'predicted_class': '主图',
    'confidence': 0.95,
    'all_probabilities': {
        '主图': 0.95,
        '细节': 0.03,
        '吊牌': 0.02
    },
    'image_path': '/path/to/image.jpg'
}
```

### 3. ClothingTrainer (src/core/pytorch_trainer.py)

模型训练器，负责模型训练和微调。

**使用示例：**
```python
from src.core.pytorch_trainer import ClothingTrainer

# 初始化训练器
trainer = ClothingTrainer(
    model_name='tf_efficientnetv2_s',
    num_classes=3,
    device='auto'
)

# 构建模型
model = trainer.build_model(pretrained=True)

# 设置优化器
trainer.setup_optimizer(lr=0.001, weight_decay=1e-4)

# 创建数据加载器
train_loader, val_loader = trainer.create_data_loaders(
    data_dir='data/',
    batch_size=32,
    val_split=0.2
)

# 训练
history = trainer.train(train_loader, val_loader, num_epochs=50)

# 保存模型
trainer.save_model('models/', prefix='best_model')
```

## GUI架构

### 界面版本

| 版本 | 文件 | 状态 | 说明 |
|-----|------|------|------|
| 传统界面 | `main_window.py` | 稳定 | PySide6经典风格 |
| 新版界面 | `native_ui.py` | 开发中 | VS Code风格 |
| 最新界面 | `test_new_ui.py` | 开发中 | 组件化设计 |

### 设计系统

位于 `src/gui/styles/` 目录：

- `colors.py` - 颜色系统（VS Code配色）
- `typography.py` - 字体排版（MiSans字体）
- `spacing.py` - 间距规范（4px网格）
- `theme.py` - 主题管理

### 组件库

位于 `src/gui/components/` 目录：

- `buttons.py` - 按钮组件
- `inputs.py` - 输入框组件
- `cards.py` - 卡片组件
- `tables.py` - 表格组件
- `others.py` - 其他组件

## 配置系统

### 配置文件

| 文件 | 说明 |
|------|------|
| `config/model_config.yaml` | 模型参数 |
| `config/training_config.yaml` | 训练参数 |
| `config/paths_config.yaml` | 路径配置 |
| `config.json` | 应用配置 |

### ConfigManager

```python
from src.utils.config_manager import ConfigManager

# 加载配置
config = ConfigManager()
config.load_all_configs()

# 获取配置值
model_name = config.get_nested_value('model_config.model.name')
```

## 数据流向

```
输入图片
    ↓
图像预处理 (ImageProcessor)
    ├── 加载图像
    ├── RGB转换
    ├── 缩放(512x512)
    └── 归一化
    ↓
模型推理 (ClothingClassifier)
    ├── EfficientNetV2-S
    ├── GPU/CPU计算
    └── Softmax输出
    ↓
结果分类 (三分类)
    ├── 主图 (class 0)
    ├── 细节 (class 1)
    └── 吊牌 (class 2)
    ↓
结果输出
    ├── 文件移动
    ├── 统计生成
    └── 日志记录
```

## 性能优化

### GPU内存管理
```python
# 每5个epoch清理一次GPU内存
if epoch % 5 == 0:
    torch.cuda.empty_cache()
    torch.cuda.synchronize()
```

### 批量处理优化
```python
# RTX 3060 12GB推荐配置
batch_size = 160  # 大批次提升GPU利用率
num_workers = 20  # 多线程预处理
```

### 混合精度推理
```python
with torch.cuda.amp.autocast():
    outputs = model(batch_tensor)
```

## 开发环境

### 依赖安装
```bash
pip install -r requirements.txt
```

### 主要依赖
- torch >= 2.0.0
- torchvision >= 0.15.0
- timm >= 0.9.0
- PySide6 >= 6.5.0
- Pillow >= 9.0.0

### 代码规范
- 使用 black 格式化代码
- 使用 flake8 检查代码风格
- 函数和类需要添加docstring

## 测试

测试文件位于 `tests/` 目录：

```bash
# 运行测试
pytest tests/

# 内存测试
python tests/memory_test.py
```

## 扩展开发

### 添加新模型

1. 在 `model_factory.py` 中注册模型：
```python
SUPPORTED_MODELS['new_model'] = {
    'timm_name': 'new_model_timm_name',
    'input_size': 224,
    'params': '50M'
}
```

2. 更新配置文件 `model_config.yaml`

### 添加新界面组件

1. 在 `src/gui/components/` 创建组件文件
2. 遵循设计系统规范
3. 在页面中导入使用

## 常见问题

### GPU内存不足
- 减小 batch_size
- 使用混合精度训练
- 清理GPU缓存

### 模型加载失败
- 检查模型文件路径
- 确认模型架构匹配
- 检查PyTorch版本兼容性
